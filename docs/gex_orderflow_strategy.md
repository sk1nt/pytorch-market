# GEX + Order Flow + MACD Strategy

## Overview

This strategy combines three powerful data sources:

1. **GEX Data** (Gamma Exposure) - Shows where market makers are hedging
2. **Order Flow** (SCID tick data) - Shows buyer/seller aggression
3. **MACD** (12, 26, 9) - Momentum indicator on 1-minute bars

## Strategy Logic

### Long Entry Conditions
- ✅ MACD crosses above signal line (bullish momentum)
- ✅ Price is above zero gamma level (positive gamma zone)
- ✅ Cumulative delta is positive (net buying pressure)

### Short Entry Conditions
- ✅ MACD crosses below signal line (bearish momentum)
- ✅ Price is below zero gamma level (negative gamma zone)
- ✅ Cumulative delta is negative (net selling pressure)

### Exit
- Opposite signal triggers
- Optional: Stop loss / take profit (configurable)

## Quick Start

### 1. Run Simple Backtest

```bash
# Using the example script (easiest)
python examples/run_gex_orderflow_backtest.py

# This will:
# - Load MNQZ25 SCID data
# - Load NQ GEX data
# - Run backtest
# - Generate performance report
# - Create visualization plots
```

### 2. Command Line Backtest

```bash
python -m market_ml.gex_orderflow_strategy \
  --scid /mnt/c/SierraChart/Data/MNQZ25_FUT_CME.scid \
  --gex outputs/backfill/NQ_NDX_gex_historical.csv \
  --output outputs/backtest_results.csv \
  --capital 10000 \
  --fee 0.0004
```

### 3. Custom Python Script

```python
from market_ml.gex_orderflow_strategy import run_full_backtest

results, metrics = run_full_backtest(
    scid_file='/mnt/c/SierraChart/Data/MNQZ25_FUT_CME.scid',
    gex_file='outputs/backfill/NQ_NDX_gex_historical.csv',
    output_file='outputs/my_backtest.csv',
    initial_capital=10000,
    transaction_fee=0.0004  # 0.04% = $0.40 per $1000
)

print(f"Total Return: {metrics['total_return_pct']:.2f}%")
print(f"Win Rate: {metrics['win_rate']:.2f}%")
print(f"Sharpe Ratio: {metrics['sharpe_ratio']:.2f}")
```

## Data Requirements

### SCID Files (Order Flow)
- Location: `/mnt/c/SierraChart/Data/`
- Available: MNQZ25, NQZ25, and others
- Contains: Tick-by-tick bid/ask volume, price, trades

### GEX Files (Gamma Exposure)
- Location: `outputs/backfill/` or `outputs/intraday/`
- Format: CSV with timestamp, zero_gamma, major strikes
- Generated by: `backfill_gex.py` and `backfill_market_hours.py`

## Output Files

After running a backtest, you'll get:

### CSV File
- `outputs/gex_orderflow_backtest.csv` or custom name
- Contains: timestamp, price, signal, MACD, delta, equity, PnL
- Every 1-minute bar with all features

### Performance Metrics
```
Initial Capital: $10,000.00
Final Equity: $12,345.67
Total Return: +23.46%
Number of Trades: 156
Win Rate: 58.3%
Max Drawdown: -8.2%
Sharpe Ratio: 1.85
```

### Visualization Plot
- `outputs/gex_orderflow_backtest.png`
- 4 subplots:
  1. Price + Zero Gamma + Entry/Exit markers
  2. MACD indicator
  3. Cumulative Delta
  4. Equity Curve

## Key Features

### MACD (Market Momentum)
- Fast EMA: 12 periods
- Slow EMA: 26 periods  
- Signal: 9 periods
- Works on 1-minute resampled data

### Order Flow Features
- `delta` = ask_volume - bid_volume (per bar)
- `cum_delta` = running sum of delta
- Positive = buyers in control
- Negative = sellers in control

### GEX Features
- `zero_gamma` = price where gamma flips
- `above_zero_gamma` = boolean, true if price > zero gamma
- `major_call_strike_1/2/3` = key resistance levels
- `major_put_strike_1/2/3` = key support levels

## Customization

### Modify Strategy Logic

Edit `market_ml/gex_orderflow_strategy.py`:

```python
def generate_signals(df):
    # Change entry conditions
    long_macd = df['macd_cross_up'] == True
    long_gex = df['above_zero_gamma'] == True
    long_delta = df['cum_delta'] > 1000  # Require stronger delta
    
    # Add additional filters
    long_volume = df['volume'] > df['volume'].rolling(20).mean()
    
    # Combine
    df.loc[long_macd & long_gex & long_delta & long_volume, 'signal'] = 1
```

### Add Risk Management

```python
results, metrics = run_full_backtest(
    scid_file=scid_path,
    gex_file=gex_path,
    initial_capital=10000,
    transaction_fee=0.0004
)

# Apply stop loss / take profit after
from market_ml.gex_orderflow_strategy import apply_risk_management

results = apply_risk_management(
    results,
    stop_loss_pct=0.02,    # 2% stop loss
    take_profit_pct=0.03   # 3% take profit
)
```

### Different Instruments

```python
# ES (S&P 500 E-mini)
results, metrics = run_full_backtest(
    scid_file='/mnt/c/SierraChart/Data/ESZ25_FUT_CME.scid',
    gex_file='outputs/backfill/ES_SPX_gex_historical.csv'
)

# SPY (ETF)
results, metrics = run_full_backtest(
    scid_file='/path/to/SPY.scid',
    gex_file='outputs/backfill/SPY_gex_historical.csv'
)
```

## Performance Tips

### Data Size
- SCID files are large (1M+ records)
- Consider date filtering for faster testing:

```python
from market_ml.data import load_sierra_chart_scid

# Load only recent data
df = load_sierra_chart_scid(scid_path, max_records=100000)
```

### Optimization
- Use subset of data for parameter testing
- Run full backtest on final parameters
- Consider parallel processing for multiple instruments

## Troubleshooting

### No GEX data available
```
Error: outputs/intraday/NQ_NDX_gex_zero_intraday.csv not found
```

**Solution**: Wait for market hours collector to run, or use backfill data:
```bash
# Check collection status
./check_status.sh

# Use backfill data instead
python examples/run_gex_orderflow_backtest.py
# (script automatically falls back to backfill data)
```

### SCID file access error
```
Error: /mnt/c/SierraChart/Data/MNQZ25_FUT_CME.scid not found
```

**Solution**: Check mount point and file path:
```bash
ls -la /mnt/c/SierraChart/Data/*.scid
```

### Memory issues with large files
```
MemoryError: Unable to allocate array
```

**Solution**: Use max_records parameter:
```python
df = load_sierra_chart_scid(scid_path, max_records=500000)
```

## Next Steps

1. **Run first backtest** on sample data
2. **Review results** and understand the signals
3. **Tweak parameters** (MACD periods, delta thresholds, etc.)
4. **Add risk management** (stops, targets, position sizing)
5. **Test on multiple instruments** (MNQ, NQ, ES, SPY)
6. **Optimize** using walk-forward analysis
7. **Paper trade** before going live

## Related Files

- `market_ml/gex_orderflow_strategy.py` - Main strategy code
- `examples/run_gex_orderflow_backtest.py` - Example runner
- `market_ml/load_trades.py` - Trade loading utilities
- `market_ml/utils.py` - PnL calculation utilities
- `market_ml/data.py` - SCID file parser
- `market_ml/backtest.py` - Generic backtest framework

## Documentation

See also:
- `docs/market_hours_collection.md` - GEX data collection
- `docs/scid_timestamp_fix.md` - SCID file format details
- `COLLECTION_STATUS.md` - Current data collection status
- `.github/copilot-instructions.md` - Project architecture guide
